// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// MODÈLE UTILISATEUR
// ===========================================
model User {
  id                    String    @id @default(cuid())
  kindeId               String    @unique @map("kinde_id")
  email                 String    @unique
  firstName             String?   @map("first_name")
  lastName              String?   @map("last_name")
  profileImage          String?   @map("profile_image")
  
  subscription          Subscription?
  invoices              Invoice[]
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ===========================================
// MODÈLE PLAN
// ===========================================
model Plan {
  id                    String    @id @default(cuid())
  name                  String    @unique
  description           String?
  
  // Prix en centimes
  priceMonthly          Int       @map("price_monthly")
  priceYearly           Int       @map("price_yearly")
  
  // IDs Stripe
  stripePriceIdMonthly  String?   @map("stripe_price_id_monthly")
  stripePriceIdYearly   String?   @map("stripe_price_id_yearly")
  stripeProductId       String?   @map("stripe_product_id")
  
  // Caractéristiques
  features              Json      @default("[]")
  
  // Limites
  maxProjects           Int?      @map("max_projects")
  maxStorage            Int?      @map("max_storage")
  maxTeamMembers        Int?      @map("max_team_members")
  
  // Flags
  isActive              Boolean   @default(true) @map("is_active")
  isPopular             Boolean   @default(false) @map("is_popular")
  
  subscriptions         Subscription[]
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("plans")
}

// ===========================================
// MODÈLE ABONNEMENT
// ===========================================
model Subscription {
  id                    String              @id @default(cuid())
  
  userId                String              @unique @map("user_id")
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId                String              @map("plan_id")
  plan                  Plan                @relation(fields: [planId], references: [id])
  
  // Stripe
  stripeCustomerId      String?             @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?             @unique @map("stripe_subscription_id")
  stripePriceId         String?             @map("stripe_price_id")
  
  // Status
  status                SubscriptionStatus  @default(ACTIVE)
  billingCycle          BillingCycle        @default(MONTHLY) @map("billing_cycle")
  
  // Dates
  currentPeriodStart    DateTime?           @map("current_period_start")
  currentPeriodEnd      DateTime?           @map("current_period_end")
  cancelAtPeriodEnd     Boolean             @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime?           @map("canceled_at")
  
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@map("subscriptions")
}

// ===========================================
// MODÈLE FACTURE
// ===========================================
model Invoice {
  id                    String        @id @default(cuid())
  
  userId                String        @map("user_id")
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe
  stripeInvoiceId       String?       @unique @map("stripe_invoice_id")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  
  // Montants
  amountPaid            Int           @map("amount_paid")
  amountDue             Int           @map("amount_due")
  currency              String        @default("eur")
  
  // Status
  status                InvoiceStatus @default(PENDING)
  
  // Détails
  description           String?
  invoicePdf            String?       @map("invoice_pdf")
  hostedInvoiceUrl      String?       @map("hosted_invoice_url")
  
  // Dates
  paidAt                DateTime?     @map("paid_at")
  dueDate               DateTime?     @map("due_date")
  
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  @@map("invoices")
}

// ===========================================
// ENUMS
// ===========================================
enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  VOID
  UNCOLLECTIBLE
}